<!DOCTYPE html>
<html>
<head>
    <title>AR.js avec gps-new-entity-place</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script>
        // Fonction pour calculer la distance entre deux points GPS
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Rayon de la terre en mètres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c;
            return d; // distance en mètres
        }

        window.onload = function() {
            // Créer un div pour afficher les logs
            const logDiv = document.createElement('div');
            logDiv.id = 'debug-log';
            logDiv.style.position = 'absolute';
            logDiv.style.top = '10px';
            logDiv.style.left = '10px';
            logDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';
            logDiv.style.color = 'white';
            logDiv.style.padding = '10px';
            logDiv.style.fontFamily = 'monospace';
            logDiv.style.zIndex = '9999';
            document.body.appendChild(logDiv);

            // Fonction pour afficher les logs
            function log(message) {
                const logEntry = document.createElement('div');
                logEntry.textContent = message;
                logDiv.appendChild(logEntry);
                console.log(message);
            }

            log("Application démarrée");

            // Vérifier la position actuelle
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const currentLat = position.coords.latitude;
                        const currentLng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        const targetLat = 44.1127778;
                        const targetLng = 1.4797222;
                        
                        const distance = calculateDistance(currentLat, currentLng, targetLat, targetLng);
                        
                        log(`Votre position: ${currentLat.toFixed(7)}, ${currentLng.toFixed(7)}`);
                        log(`Précision: ±${accuracy.toFixed(1)} mètres`);
                        log(`Distance avec l'objet: ${distance.toFixed(1)} mètres`);
                        
                        if (distance > 100) {
                            log("ALERTE: L'objet est à plus de 100 mètres!");
                        }
                    },
                    (error) => {
                        log(`Erreur GPS: ${error.message} (code ${error.code})`);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 27000
                    }
                );
            } else {
                log("Géolocalisation non supportée par ce navigateur");
            }
        };

        // Écouter les événements de l'objet AR
        AFRAME.registerComponent('box-loaded', {
            init: function() {
                const logDiv = document.getElementById('debug-log');
                const logEntry = document.createElement('div');
                logEntry.textContent = "Box initialisée";
                logDiv.appendChild(logEntry);

                this.el.addEventListener('gps-entity-place-loaded', function() {
                    const logEntry = document.createElement('div');
                    logEntry.textContent = "✅ Box GPS chargée correctement!";
                    logDiv.appendChild(logEntry);
                });

                this.el.addEventListener('gps-entity-place-update-position', function(evt) {
                    const logEntry = document.createElement('div');
                    logEntry.textContent = `Box position mise à jour: ${evt.detail.distance.toFixed(2)}m`;
                    logDiv.appendChild(logEntry);
                });
            }
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        vr-mode-ui="enabled: false"
    >
        <a-box 
            box-loaded
            gps-new-entity-place="latitude: 44.1127778; longitude: 1.4797222"
            material="color: red;"
            scale="20 20 20"
            position="0 0 0"
        ></a-box>
        <a-camera gps-new-camera rotation-reader></a-camera>
    </a-scene>
</body>
</html>